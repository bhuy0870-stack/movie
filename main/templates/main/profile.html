{% extends 'main/base.html' %}
{% load static %}

{% block title %}Hồ sơ - {{ user.username }}{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
    :root {
        --primary-red: #e50914;
        --gold: #ffcc00;
        --surface: rgba(255, 255, 255, 0.03);
        --border: rgba(255, 255, 255, 0.08);
        --transition: 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    }

    body { 
        background: radial-gradient(circle at top, #1a1a1a 0%, #050505 100%); 
        color: #fff; 
        font-family: 'Inter', sans-serif;
    }

    /* --- PROFILE CARD PREMIUM --- */
    .profile-card {
        background: rgba(15, 15, 15, 0.7);
        backdrop-filter: blur(20px);
        border-radius: 35px;
        border: 1px solid var(--border);
        overflow: hidden;
        box-shadow: 0 40px 100px rgba(0,0,0,0.8);
        margin-top: 50px;
        margin-bottom: 80px;
    }

    .profile-header {
        padding: 60px 20px;
        text-align: center;
        background: linear-gradient(to bottom, rgba(229, 9, 20, 0.05), transparent);
        border-bottom: 1px solid var(--border);
    }

    /* Avatar Glow Effect */
    .avatar-wrapper {
        position: relative;
        display: inline-block;
        cursor: pointer;
    }

    .avatar-main {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #fff;
        padding: 3px;
        background: #000;
        transition: var(--transition);
        box-shadow: 0 0 30px rgba(255,255,255,0.1);
    }

    .avatar-wrapper:hover .avatar-main {
        border-color: var(--primary-red);
        box-shadow: 0 0 40px rgba(229, 9, 20, 0.4);
        transform: scale(1.02);
    }

    .camera-overlay {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background: var(--primary-red);
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 4px solid #0f0f0f;
        color: white;
        transition: 0.3s;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }

    .username-display {
        font-family: 'Montserrat', sans-serif;
        font-weight: 800;
        font-size: 2.2rem;
        letter-spacing: -1px;
        margin-top: 25px;
        background: linear-gradient(to bottom, #fff, #999);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* --- ACHIEVEMENT CHIP --- */
    .achievement-section {
        background: var(--surface);
        border-radius: 25px;
        padding: 25px;
        border: 1px solid var(--border);
    }

    .badge-item {
        width: 65px;
        height: 65px;
        background: rgba(255,255,255,0.03);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        transition: 0.3s;
        border: 1px solid var(--border);
        cursor: pointer;
    }

    .badge-item:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--gold);
        transform: translateY(-5px) rotate(5deg);
    }

    /* --- INFO LIST --- */
    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 20px 0;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .info-item:last-child { border-bottom: none; }

    .info-label { color: #888; font-size: 0.9rem; font-weight: 500; }
    .info-value { font-weight: 700; color: #eee; }

    /* --- ACTION BUTTONS --- */
    .btn-action {
        border-radius: 18px;
        padding: 16px;
        font-weight: 800;
        font-size: 0.9rem;
        letter-spacing: 1px;
        transition: 0.3s;
    }

    .btn-logout {
        background: #fff;
        color: #000;
        border: none;
    }

    .btn-logout:hover {
        background: var(--primary-red);
        color: #fff;
        transform: translateY(-2px);
    }

    .btn-home {
        background: transparent;
        color: #fff;
        border: 1px solid var(--border);
    }

    .btn-home:hover {
        background: rgba(255,255,255,0.05);
        color: #fff;
    }

    @media (max-width: 768px) {
        .profile-card { margin-top: 0; border-radius: 0; border: none; }
        .username-display { font-size: 1.8rem; }
        .avatar-main { width: 120px; height: 120px; }
    }
</style>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-xl-5 col-lg-6 col-md-8 col-12 px-0 px-md-3">
            <div class="profile-card">
                <div class="profile-header">
                    <form id="avatar-form" action="{% url 'update_avatar' %}" method="post" enctype="multipart/form-data" class="d-none">
                        {% csrf_token %}
                        <input type="file" id="avatar-input" name="avatar" accept="image/*" onchange="submitAvatar()">
                    </form>

                    <div class="avatar-wrapper" onclick="document.getElementById('avatar-input').click()">
                        {% if profile.avatar %}
                            <img src="{{ profile.avatar.url }}" class="avatar-main" id="avatar-display">
                        {% else %}
                            <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=e50914&color=fff&size=250" class="avatar-main" id="avatar-display">
                        {% endif %}
                        <div class="camera-overlay">
                            <i class="fas fa-camera" id="camera-icon"></i>
                        </div>
                    </div>

                    <h2 class="username-display">{{ user.username|upper }}</h2>
                    <div class="d-flex align-items-center justify-content-center gap-2 mt-2">
                        <span class="badge bg-warning text-dark fw-bold rounded-pill px-3" style="font-size: 0.65rem;">
                            <i class="fas fa-crown me-1"></i>MEMBER VIP
                        </span>
                    </div>
                    <p class="text-white-50 small mt-3 mb-0">{{ user.email }}</p>
                </div>

                <div class="card-body p-4 p-md-5">
                    <div class="achievement-section mb-5">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <span style="font-size: 0.75rem; font-weight: 800; letter-spacing: 2px; color: var(--gold);">THÀNH TỰU</span>
                            <span class="text-white-50 small">{{ achievements|length }} badges</span>
                        </div>
                        
                        <div class="d-flex flex-wrap gap-3 justify-content-start">
                            {% for ua in achievements %}
                                <div class="badge-item" onclick="showBadge('{{ ua.achievement.name }}', '{{ ua.achievement.description }}')" title="{{ ua.achievement.name }}">
                                    <i class="{{ ua.achievement.icon_class }}" style="color: {{ ua.achievement.color }};"></i>
                                </div>
                            {% empty %}
                                <div class="w-100 text-center py-2 opacity-25">
                                    <p class="small mb-0 italic">Bắt đầu khám phá để nhận huy hiệu</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mb-5">
                        <div class="info-item">
                            <span class="info-label">Ngày sinh</span>
                            <span class="info-value">{{ user.last_name|default:"Chưa cập nhật" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tuổi hội viên</span>
                            <span class="info-value text-warning">{{ user_age }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Gia nhập ngày</span>
                            <span class="info-value small text-white-50">{{ user.date_joined|date:"d/m/Y" }}</span>
                        </div>
                    </div>

                    <div class="d-grid gap-3">
                        <form action="{% url 'logout' %}" method="post" class="m-0 d-grid">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-action btn-logout">
                                <i class="fas fa-power-off me-2"></i> ĐĂNG XUẤT
                            </button>
                        </form>
                        <a href="{% url 'home' %}" class="btn btn-action btn-home">
                            <i class="fas fa-arrow-left me-2"></i> VỀ TRANG CHỦ
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function submitAvatar() {
        const icon = document.getElementById('camera-icon');
        icon.className = "fas fa-circle-notch fa-spin";
        document.getElementById('avatar-display').style.opacity = "0.4";
        document.getElementById('avatar-form').submit();
    }

    function showBadge(name, desc) {
        // Có thể thay thế bằng một Modal đẹp hơn sau này
        alert(name + ": " + desc);
    }
</script>
{% endblock %}