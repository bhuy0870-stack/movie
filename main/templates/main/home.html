{% extends 'main/base.html' %}
{% load static %}

{% block content %}
<style>
    /* --- HỆ THỐNG BIẾN & CORE STYLE --- */
    :root {
        --primary-red: #e50914;
        --accent-red: #ff3c3c;
        --dark-bg: #050505;
        --card-bg: #111111;
        --glass-white: rgba(255, 255, 255, 0.05);
        --glass-border: rgba(255, 255, 255, 0.1);
        --shadow-red: rgba(229, 9, 20, 0.4);
        --transition-main: all 0.5s cubic-bezier(0.2, 1, 0.3, 1);
    }

    body { background-color: var(--dark-bg); color: #ececec; font-family: 'Inter', sans-serif; overflow-x: hidden; }

    /* --- HIỆU ỨNG TEXT --- */
    .glow-text {
        font-weight: 800;
        text-transform: uppercase;
        background: linear-gradient(180deg, #fff 30%, rgba(255,255,255,0.5) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: 1px;
    }

    /* --- NÂNG CẤP HERO CAROUSEL --- */
    #heroCarousel { border-radius: 28px; overflow: hidden; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .carousel-item { height: 550px; overflow: hidden; }
    .carousel-item img { width: 100%; height: 100%; object-fit: cover; animation: kenburns 20s infinite alternate; }
    @keyframes kenburns { from { transform: scale(1); } to { transform: scale(1.1); } }

    .hero-vignette {
        position: absolute; inset: 0;
        background: radial-gradient(circle at 20% 50%, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.9) 100%),
                    linear-gradient(to top, var(--dark-bg) 5%, transparent 50%);
    }

    /* --- MOVIE CARD HIỆU ỨNG MỚI --- */
    .movie-card {
        position: relative; background: var(--card-bg); border-radius: 16px;
        border: 1px solid var(--glass-border); transition: var(--transition-main);
    }
    .movie-card:hover { 
        transform: translateY(-12px) scale(1.02); 
        border-color: var(--primary-red); 
        box-shadow: 0 15px 35px rgba(0,0,0,0.6), 0 0 15px var(--shadow-red);
    }
    .card-img-wrapper { position: relative; aspect-ratio: 2/3; overflow: hidden; border-radius: 14px; }
    .movie-card:hover .card-img-wrapper img { filter: brightness(0.6) blur(2px); transform: scale(1.08); }

    .card-hover-detail {
        position: absolute; inset: 0; display: flex; flex-direction: column; 
        justify-content: center; align-items: center; opacity: 0; 
        transform: translateY(15px); transition: var(--transition-main);
    }
    .movie-card:hover .card-hover-detail { opacity: 1; transform: translateY(0); }

    .btn-play-sm {
        width: 45px; height: 45px; background: var(--primary-red);
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        color: white; box-shadow: 0 0 15px var(--primary-red);
    }

    /* --- NÚT DONATE --- */
    .floating-donate {
        position: fixed; bottom: 35px; right: 35px; z-index: 1000;
        width: 65px; height: 65px; border-radius: 50%;
        background: linear-gradient(135deg, #ffd700, #ffa500);
        color: #000; border: none; font-size: 1.5rem;
        box-shadow: 0 8px 25px rgba(255, 165, 0, 0.4); cursor: pointer; transition: 0.3s;
    }
    .floating-donate:hover { transform: scale(1.1) rotate(10deg); }
    @keyframes wiggle { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-8deg); } 75% { transform: rotate(8deg); } }
    .btn-wiggle { animation: wiggle 2.5s infinite ease-in-out; }

    /* --- SIDEBAR RANKING (Dùng cho Phim Hot) --- */
    .ranking-container { background: rgba(255,255,255,0.02); padding: 20px; border-radius: 24px; border: 1px solid var(--glass-border); }
    .rank-item {
        display: flex; align-items: center; gap: 12px; padding: 10px;
        border-radius: 12px; transition: 0.3s; text-decoration: none;
    }
    .rank-item:hover { background: rgba(255,255,255,0.05); transform: translateX(8px); }
    .rank-idx { font-size: 1.4rem; font-weight: 900; color: var(--primary-red); font-style: italic; width: 30px; opacity: 0.8; }

    .qr-frame { background: #fff; padding: 12px; border-radius: 18px; display: inline-block; }
    .qr-frame img { width: 230px; height: 230px; object-fit: contain; }
</style>

<button class="floating-donate btn-wiggle" data-bs-toggle="modal" data-bs-target="#donateModal">
    <i class="fas fa-mug-hot"></i>
</button>

<div class="container-fluid px-lg-5 mt-4">
    {# 1. PHẦN ĐẦU TRANG: HERO SLIDER & VIP CARD #}
    {% if movies_page.number == 1 and not request.GET.q %}
    <div class="row g-4 mb-5">
        <div class="col-lg-9">
            <div id="heroCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for movie in featured_movies|slice:":3" %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        <img src="{{ movie.poster_url }}" alt="{{ movie.title }}">
                        <div class="hero-vignette"></div>
                        <div class="carousel-caption d-none d-md-block text-start h-100 d-flex align-items-center" style="left: 7%; bottom: 0; max-width: 550px; z-index: 10;">
                            <div>
                                <span class="badge bg-danger mb-3 px-3 py-2 rounded-pill shadow">PHIM ĐỀ CỬ</span>
                                <h1 class="display-3 fw-bold text-white mb-3" style="text-shadow: 2px 2px 15px rgba(0,0,0,0.8);">{{ movie.title|upper }}</h1>
                                <p class="fs-6 text-light opacity-75 mb-4">{{ movie.description|truncatechars:120 }}</p>
                                <div class="d-flex gap-3">
                                    <a href="{% url 'movie_detail' movie.slug %}" class="btn btn-danger btn-lg px-5 py-3 rounded-pill fw-bold shadow-lg">
                                        <i class="fas fa-play me-2"></i> XEM NGAY
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="h-100 p-4 rounded-4 d-flex flex-column justify-content-center text-center border border-white border-opacity-10" 
                 style="background: linear-gradient(145deg, #1a1a1a, #000);">
                <i class="fas fa-crown fa-4x text-warning mb-4"></i>
                <h3 class="fw-bold mb-3">BQH MOVIE+</h3>
                <p class="text-white-50 small mb-4">Trải nghiệm chất lượng 4K Ultra HD, không quảng cáo và ưu tiên phim mới.</p>
                <button class="btn btn-warning py-3 rounded-pill fw-bold w-100 shadow-sm" data-bs-toggle="modal" data-bs-target="#donateModal">
                    <i class="fas fa-gem me-2"></i>NÂNG CẤP NGAY
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    {# 2. PHẦN NỘI DUNG CHÍNH: PHIM MỚI NHẤT #}
    <div class="row g-4">
        <div class="col-lg-9">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h2 class="glow-text m-0">
                    {% if request.GET.q %}KẾT QUẢ CHO: "{{ request.GET.q }}"{% else %}PHIM MỚI CẬP NHẬT{% endif %}
                </h2>
                <div class="d-none d-md-block bg-danger opacity-50" style="height: 2px; flex-grow: 1; margin-left: 20px; border-radius: 2px;"></div>
            </div>

            <div class="row row-cols-2 row-cols-md-3 row-cols-xl-5 g-4">
                {% for movie in movies_page %}
                <div class="col">
                    <div class="movie-card h-100">
                        <a href="{% url 'movie_detail' movie.slug %}" class="text-decoration-none">
                            <div class="card-img-wrapper">
                                <img src="{{ movie.poster_url }}" class="w-100 h-100 object-fit-cover" alt="{{ movie.title }}" loading="lazy">
                                
                                <div class="position-absolute top-0 start-0 m-2 d-flex flex-column gap-1">
                                    <span class="badge bg-primary shadow-sm" style="font-size: 9px;">NEW</span>
                                    {% if movie.imdb_rating >= 8 %}
                                    <span class="badge bg-danger shadow-sm" style="font-size: 9px;">HOT</span>
                                    {% endif %}
                                </div>

                                <div class="card-hover-detail">
                                    <div class="btn-play-sm mb-2 shadow-lg"><i class="fas fa-play"></i></div>
                                    <span class="text-white fw-bold small">IMDb: {{ movie.imdb_rating }}</span>
                                </div>
                            </div>
                            <div class="p-3">
                                <h6 class="text-white text-truncate m-0 fw-bold small text-uppercase" title="{{ movie.title }}">{{ movie.title }}</h6>
                                <div class="d-flex justify-content-between mt-2 opacity-50" style="font-size: 10px;">
                                    <span>{{ movie.release_date }}</span>
                                    <span class="text-danger">PREMIUM</span>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-5">
                    <h5 class="text-white-50">Không tìm thấy nội dung yêu cầu...</h5>
                </div>
                {% endfor %}
            </div>

            {# PHÂN TRANG #}
            {% if movies_page.has_other_pages %}
            <div class="d-flex justify-content-center mt-5 mb-5">
                <nav class="d-flex align-items-center gap-3">
                    {% if movies_page.has_previous %}
                    <a href="?page={{ movies_page.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="btn btn-dark rounded-circle border-secondary border-opacity-25 shadow"><i class="fas fa-chevron-left mt-1"></i></a>
                    {% endif %}
                    <span class="px-4 py-2 bg-dark rounded-pill border border-secondary border-opacity-25 small fw-bold">
                        {{ movies_page.number }} / {{ movies_page.paginator.num_pages }}
                    </span>
                    {% if movies_page.has_next %}
                    <a href="?page={{ movies_page.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="btn btn-dark rounded-circle border-secondary border-opacity-25 shadow"><i class="fas fa-chevron-right mt-1"></i></a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}
        </div>

        {# 3. THANH BÊN: PHIM HOT NHẤT (BẢNG XẾP HẠNG) #}
        <div class="col-lg-3">
            <div class="ranking-container">
                <h5 class="glow-text mb-4" style="font-size: 1rem;">PHIM HOT NHẤT</h5>
                <div class="d-flex flex-column gap-2">
                    {% for movie in hot_movies %}
                    <a href="{% url 'movie_detail' movie.slug %}" class="rank-item">
                        <span class="rank-idx">{{ forloop.counter }}</span>
                        <img src="{{ movie.poster_url }}" width="45" height="60" class="rounded object-fit-cover shadow-sm">
                        <div class="overflow-hidden">
                            <h6 class="text-white small fw-bold mb-0 text-truncate">{{ movie.title }}</h6>
                            <div class="text-warning" style="font-size: 10px;">
                                <i class="fas fa-star me-1"></i>{{ movie.imdb_rating }} IMDb
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                
                <hr class="my-4 border-secondary border-opacity-20">
                
                <div class="p-3 rounded-4 bg-danger bg-opacity-10 border border-danger border-opacity-20">
                    <h6 class="text-danger fw-bold small mb-2"><i class="fas fa-bell me-2"></i>LƯU Ý</h6>
                    <p class="text-white-50 mb-0" style="font-size: 11px;">Nếu link phim bị lỗi, vui lòng nhấn nút "Báo lỗi" hoặc Donate để Admin fix nhanh nhất!</p>
                </div>
            </div>
        </div>
    </div>
</div>

{# MODAL DONATE HOÀN CHỈNH #}
<div class="modal fade" id="donateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border border-secondary shadow-lg" style="border-radius: 28px;">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-4 pt-0">
                <h4 class="text-warning fw-bold mb-4">MỜI ADMIN LY CAFE</h4>
                <div class="qr-frame mb-4 shadow">
                    <img src="{% static 'images/vcb_qr.jpg' %}" alt="QR Donate" onerror="this.src='https://img.vietqr.io/image/vcb-1025765518-compact2.jpg?amount=50000&addInfo=Ung%20ho%20BQH%20Movie&accountName=BANH%20QUANG%20HUY'">
                </div>

                <div class="text-start p-3 rounded-4 mb-3" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-white-50 small">Ngân hàng</span>
                        <span class="text-white small fw-bold">VIETCOMBANK (VCB)</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-white-50 small">Số tài khoản</span>
                        <span class="text-white small fw-bold">1025765518</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-white-50 small">Chủ tài khoản</span>
                        <span class="text-white small fw-bold">BANH QUANG HUY</span>
                    </div>
                </div>
                <div class="p-2 rounded-3 text-center" style="background: rgba(229, 9, 20, 0.1); border: 1px dashed rgba(229, 9, 20, 0.4);">
                    <small class="text-danger fw-bold">Nội dung: Ung ho BQH Movie</small>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="py-5 mt-5 border-top border-secondary border-opacity-10">
    <div class="container text-center">
        <h3 class="fw-bold text-danger mb-3">BQH MOVIE</h3>
        <p class="text-white-50 small mb-0">© 2026 Developed by BQH Team. Chúc bạn xem phim vui vẻ!</p>
    </div>
</footer>
{% endblock %}