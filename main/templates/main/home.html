{% extends 'main/base.html' %}
{% load static %}

{% block content %}
<style>
    /* --- HỆ THỐNG BIẾN & CÀI ĐẶT CHUNG --- */
    :root {
        --primary-red: #e50914;
        --accent-red: #ff1f1f;
        --dark-bg: #060606;
        --card-bg: #121212;
        --glass: rgba(255, 255, 255, 0.05);
        --glass-border: rgba(255, 255, 255, 0.1);
        --text-dim: #9ca3af;
        --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* --- HIỆU ỨNG RUNG (WIGGLE ANIMATION) --- */
    @keyframes wiggle {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(-3deg); }
        50% { transform: rotate(3deg); }
        75% { transform: rotate(-1deg); }
    }

    .btn-wiggle {
        animation: wiggle 2s infinite ease-in-out;
        display: inline-block;
    }
    
    .btn-wiggle:hover {
        animation: none;
        transform: scale(1.05);
    }

    /* --- HIỆU ỨNG CHỮ PHÁT SÁNG --- */
    .glow-text {
        font-weight: 900;
        letter-spacing: -1px;
        background: linear-gradient(to bottom, #fff 50%, #888 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-transform: uppercase;
    }

    /* --- DONATE TOP BOX --- */
    .donate-top-card {
        background: linear-gradient(145deg, rgba(229, 9, 20, 0.15) 0%, rgba(0,0,0,0.6) 100%);
        border: 1px solid rgba(229, 9, 20, 0.4);
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        transition: var(--transition);
        backdrop-filter: blur(10px);
    }
    .donate-top-card:hover {
        border-color: var(--primary-red);
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(229, 9, 20, 0.2);
    }

    /* --- CATEGORY CHIPS --- */
    .cat-chip {
        background: var(--glass);
        border: 1px solid var(--glass-border);
        color: white;
        padding: 10px 22px;
        border-radius: 12px;
        text-decoration: none;
        white-space: nowrap;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        font-weight: 600;
    }
    .cat-chip:hover, .active-chip {
        background: var(--primary-red) !important;
        border-color: var(--primary-red) !important;
        color: white !important;
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(229, 9, 20, 0.3);
    }

    /* --- MOVIE CARD --- */
    .movie-card {
        position: relative;
        background: var(--card-bg);
        border-radius: 18px;
        padding: 8px;
        border: 1px solid var(--glass-border);
        transition: var(--transition);
    }
    .movie-card:hover {
        transform: translateY(-10px);
        border-color: var(--primary-red);
        box-shadow: 0 20px 40px rgba(0,0,0,0.6);
    }

    .card-img-wrapper {
        border-radius: 14px;
        overflow: hidden;
        position: relative;
        aspect-ratio: 2/3;
    }
    .card-img-wrapper img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.6s ease; }
    .movie-card:hover .card-img-wrapper img { transform: scale(1.08); }

    .play-overlay {
        position: absolute; inset: 0;
        background: rgba(0,0,0,0.4);
        display: flex; align-items: center; justify-content: center;
        opacity: 0; transition: 0.3s;
    }
    .movie-card:hover .play-overlay { opacity: 1; }

    .play-btn-blur {
        width: 50px; height: 50px;
        background: var(--primary-red);
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        color: white; font-size: 1rem;
        transform: scale(0.6); transition: var(--transition);
    }
    .movie-card:hover .play-btn-blur { transform: scale(1); }

    .badge-premium {
        position: absolute; top: 12px; left: 12px;
        background: rgba(229, 9, 20, 0.9);
        padding: 3px 8px; border-radius: 6px; font-size: 0.6rem; font-weight: 900;
        letter-spacing: 1px;
    }

    /* --- SIDEBAR RANKING --- */
    .ranking-item {
        background: rgba(255,255,255,0.03);
        border-radius: 14px;
        padding: 10px;
        border: 1px solid transparent;
        transition: 0.3s;
    }
    .ranking-item:hover {
        background: rgba(255,255,255,0.07);
        border-color: var(--glass-border);
        transform: translateX(5px);
    }
    .rank-number { font-size: 1.8rem; font-weight: 900; opacity: 0.15; font-style: italic; color: white; }

    /* --- NÚT DONATE GÓC PHẢI --- */
    .floating-donate {
        position: fixed; 
        bottom: 30px; 
        right: 30px; 
        z-index: 999;
        background: #ffc107; 
        color: #000; 
        width: 55px; 
        height: 55px;
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        box-shadow: 0 10px 25px rgba(255, 193, 7, 0.4); 
        border: none; 
        cursor: pointer;
        transition: 0.3s;
    }
    .floating-donate:hover { transform: scale(1.1) rotate(15deg); }

    /* --- FIX LỖI QR KHUẤT --- */
    .qr-container {
        background: white;
        padding: 20px; /* Tăng padding để tạo khoảng cách an toàn */
        border-radius: 20px;
        display: inline-block;
        margin-bottom: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .qr-container img {
        width: 260px; /* Tăng nhẹ kích thước hiển thị */
        height: 260px;
        object-fit: contain; /* QUAN TRỌNG: contain giúp ảnh không bị cắt mép */
        border-radius: 0; /* QR không nên bo tròn sâu để tránh lỗi quét */
        display: block;
    }

    .cinema-footer {
        margin-top: 80px; padding: 60px 0 30px;
        background: #000;
        border-top: 1px solid var(--glass-border);
    }
    .social-icon {
        width: 40px; height: 40px; background: var(--glass);
        border-radius: 10px; display: inline-flex; align-items: center; justify-content: center;
        color: white; text-decoration: none; transition: 0.3s;
    }
    .social-icon:hover { background: var(--primary-red); transform: translateY(-3px); color: white; }

    .custom-scrollbar::-webkit-scrollbar { height: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--primary-red); border-radius: 10px; }
</style>

<button class="floating-donate btn-wiggle" data-bs-toggle="modal" data-bs-target="#donateModal" title="Ủng hộ Admin">
    <i class="fas fa-coffee"></i>
</button>

<div class="container-fluid px-lg-5 mt-4">
    {# 1. HERO SECTION & DONATE TOP #}
    {% if movies_page.number == 1 and not request.GET.genre and not request.GET.q %}
    <div class="row g-4 mb-5">
        <div class="col-lg-9">
            <div id="heroCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel">
                <div class="carousel-inner rounded-4 overflow-hidden shadow-lg">
                    {% for movie in featured_movies|slice:":3" %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}" style="height: 480px; background: url('{{ movie.poster_url }}') center/20% repeat, url('{{ movie.poster_url }}') center/cover;">
                        <div style="position: absolute; inset: 0; background: linear-gradient(90deg, #000 20%, transparent 100%);"></div>
                        <div class="carousel-caption d-none d-md-block text-start h-100 d-flex align-items-center" style="left: 6%; bottom: 0; max-width: 600px;">
                            <div>
                                <span class="badge bg-danger mb-3 px-3 py-2 rounded-pill small fw-bold">XU HƯỚNG TRONG TUẦN</span>
                                <h1 class="display-4 fw-900 mb-2 text-uppercase" style="letter-spacing: -1.5px;">{{ movie.title }}</h1>
                                <div class="d-flex align-items-center gap-3 mb-4 text-white-50 small">
                                    <span class="text-warning fw-bold"><i class="fas fa-star me-1"></i>{{ movie.imdb_rating }}</span>
                                    <span>•</span>
                                    <span>{{ movie.release_date|date:"Y" }}</span>
                                    <span class="badge border border-danger text-danger">4K ULTRA HD</span>
                                </div>
                                <p class="fs-6 mb-4 opacity-75 lh-base" style="max-width: 450px;">{{ movie.description|truncatechars:120 }}</p>
                                <a href="{% url 'movie_detail' movie.id %}" class="btn btn-danger px-5 py-3 rounded-3 fw-800 shadow-lg">
                                    <i class="fas fa-play me-2"></i> XEM NGAY
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-3">
            <div class="donate-top-card p-4 rounded-4 text-center">
                <div class="mb-3">
                    <div class="d-inline-block p-3 rounded-circle bg-danger bg-opacity-10 mb-3">
                        <i class="fas fa-heart text-danger fa-2x"></i>
                    </div>
                    <h5 class="fw-bold text-white mb-2 text-uppercase">Ủng hộ Admin</h5>
                    <p class="text-white-50 small mb-4">Giúp BQH MOVIE duy trì server phim 4K không quảng cáo bạn nhé!</p>
                </div>
                <div class="mt-auto">
                    <button class="btn btn-warning w-100 rounded-pill fw-bold mb-3 shadow-sm btn-wiggle" data-bs-toggle="modal" data-bs-target="#donateModal">
                        <i class="fas fa-qrcode me-2"></i>DONATE NGAY
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {# 2. CATEGORY CHIPS #}
    <div class="mb-5">
        <div class="d-flex gap-3 overflow-auto pb-3 custom-scrollbar">
            <a href="{% url 'home' %}" class="cat-chip {% if not request.GET.genre %}active-chip{% endif %}">
                <i class="fas fa-border-all"></i> Tất cả
            </a>
            {% for g in genre_list %}
            <a href="?genre={{ g }}" class="cat-chip {% if request.GET.genre == g %}active-chip{% endif %}">
                <i class="fas 
                    {% if g == 'Hành động' %}fa-bolt
                    {% elif g == 'Kinh dị' %}fa-skull
                    {% elif g == 'Tình cảm' %}fa-heart
                    {% elif g == 'Viễn tưởng' %}fa-rocket
                    {% elif g == 'Hoạt hình' %}fa-dragon
                    {% elif g == 'Hài hước' %}fa-laugh
                    {% else %}fa-film{% endif %}">
                </i> 
                {{ g }}
            </a>
            {% endfor %}
        </div>
    </div>

    <div class="row g-4">
        {# 3. MAIN MOVIE GRID #}
        <div class="col-lg-9">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h4 class="glow-text m-0">
                    {% if request.GET.genre %}{{ request.GET.genre }}{% elif request.GET.q %}Tìm kiếm: {{ request.GET.q }}{% else %}Mới Cập Nhật{% endif %}
                </h4>
            </div>
            
            <div class="row row-cols-2 row-cols-md-3 row-cols-xl-5 g-3">
                {% for movie in movies_page %}
                <div class="col">
                    <div class="movie-card h-100">
                        <a href="{% url 'movie_detail' movie.id %}" class="text-decoration-none">
                            <div class="card-img-wrapper">
                                <img src="{{ movie.poster_url }}" alt="{{ movie.title }}" loading="lazy">
                                <div class="play-overlay">
                                    <div class="play-btn-blur"><i class="fas fa-play"></i></div>
                                </div>
                                <div class="badge-premium">HDR</div>
                            </div>
                            <div class="pt-3 px-1 text-center">
                                <h6 class="text-white text-truncate mb-1 fw-bold small">{{ movie.title }}</h6>
                                <div class="d-flex justify-content-center align-items-center gap-2">
                                    <span class="text-white-50" style="font-size: 0.7rem;">{{ movie.release_date|date:"Y" }}</span>
                                    <span class="text-warning fw-bold" style="font-size: 0.75rem;"><i class="fas fa-star me-1"></i>{{ movie.imdb_rating }}</span>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-5">
                    <i class="fas fa-search fa-3x text-white-50 mb-3"></i>
                    <p class="text-white-50">Không tìm thấy phim nào phù hợp.</p>
                </div>
                {% endfor %}
            </div>

            {# PHÂN TRANG #}
            {% if movies_page.has_other_pages %}
            <div class="d-flex justify-content-center mt-5 mb-5">
                <nav class="d-flex align-items-center gap-3">
                    {% if movies_page.has_previous %}
                        <a href="?page={{ movies_page.previous_page_number }}{% if request.GET.genre %}&genre={{ request.GET.genre }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="social-icon"><i class="fas fa-chevron-left"></i></a>
                    {% endif %}
                    <span class="fw-bold px-4 py-2 rounded-pill border border-secondary small">Trang {{ movies_page.number }} / {{ movies_page.paginator.num_pages }}</span>
                    {% if movies_page.has_next %}
                        <a href="?page={{ movies_page.next_page_number }}{% if request.GET.genre %}&genre={{ request.GET.genre }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="social-icon"><i class="fas fa-chevron-right"></i></a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}
        </div>

        {# 4. SIDEBAR RANKING #}
        <div class="col-lg-3 d-none d-lg-block">
            <div style="position: sticky; top: 90px;">
                <h5 class="glow-text mb-4">Thịnh Hành</h5>
                <div class="d-flex flex-column gap-3">
                    {% for movie in featured_movies|slice:":5" %}
                    <a href="{% url 'movie_detail' movie.id %}" class="text-decoration-none ranking-item d-flex align-items-center gap-3">
                        <span class="rank-number">{{ forloop.counter }}</span>
                        <img src="{{ movie.poster_url }}" class="rounded shadow" width="45" height="65" style="object-fit: cover;">
                        <div class="overflow-hidden">
                            <h6 class="text-white small fw-bold mb-1 text-truncate">{{ movie.title }}</h6>
                            <div class="d-flex align-items-center gap-2">
                                <span class="text-warning fw-bold" style="font-size: 0.7rem;"><i class="fas fa-star me-1"></i>{{ movie.imdb_rating }}</span>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="donateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border border-secondary shadow-lg" style="border-radius: 25px;">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-warning fw-bold"><i class="fas fa-university me-2"></i>Thông tin chuyển khoản</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div class="qr-container">
                    <img src="{% static 'images/vcb_qr.jpg' %}" alt="QR Vietcombank" onerror="this.src='https://via.placeholder.com/260x260?text=QR+Not+Found'">
                    <p class="text-dark small mt-3 mb-0 fw-bold" style="letter-spacing: 1px;">QUÉT MÃ ĐỂ DONATE</p>
                </div>
                
                <div class="text-start bg-black bg-opacity-50 p-3 rounded-4 border border-secondary border-opacity-40">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-white-50 small">Ngân hàng:</span>
                        <span class="text-white small fw-bold">VIETCOMBANK (VCB)</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-white-50 small">Số tài khoản:</span>
                        <span class="text-white small fw-bold">1025765518</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-white-50 small">Chủ tài khoản:</span>
                        <span class="text-white small fw-bold text-uppercase">BANH QUANG HUY</span>
                    </div>
                </div>
                <div class="mt-3 p-2 rounded-3" style="background: rgba(229, 9, 20, 0.1); border: 1px dashed rgba(229, 9, 20, 0.3);">
                    <p class="text-danger small mb-0">Nội dung: <strong>Ung ho BQH Movie</strong></p>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="cinema-footer">
    <div class="container">
        <div class="row g-4 justify-content-between">
            <div class="col-lg-4 text-center text-lg-start">
                <h3 class="fw-900 text-danger mb-3">BQH <span class="text-white">MOVIE</span></h3>
                <p class="text-white-50 small">Nền tảng xem phim chất lượng cao hoàn toàn miễn phí.</p>
                <div class="d-flex justify-content-center justify-content-lg-start gap-3 mt-4">
                    <a href="https://www.facebook.com/huy.banh.96199/" target="_blank" class="social-icon"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://www.instagram.com/banh_quanghuy/" target="_blank" class="social-icon"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            <div class="col-lg-6 text-center text-lg-end">
                <p class="text-white-50 small m-0">© 2026 BQH MOVIE. Phát triển bởi BQH Team.</p>
            </div>
        </div>
    </div>
</footer>
{% endblock %}