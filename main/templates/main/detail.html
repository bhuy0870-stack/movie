{% extends 'main/base.html' %}
{% block title %}{{ movie.title }} - BQH MOVIE{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
    :root { 
        --accent: #ffcc33; 
        --bg: #050505; 
        --surface: rgba(255, 255, 255, 0.03);
        --border: rgba(255, 255, 255, 0.08);
        --primary-gold: #ffcc33;
    }

    body { 
        background-color: var(--bg); 
        color: #efefef; 
        font-family: 'Inter', sans-serif !important;
        -webkit-font-smoothing: antialiased;
    }

    /* --- TIÊU ĐỀ PHIM --- */
    .movie-title { 
        font-family: 'Montserrat', sans-serif !important; 
        font-size: clamp(1.8rem, 4vw, 2.4rem); 
        font-weight: 800; 
        letter-spacing: -0.02em; 
        color: #fff;
        margin-bottom: 10px;
    }

    .description-box p {
        font-family: 'Inter', sans-serif !important;
        color: #bbb;
        line-height: 1.8;
    }

    /* --- PLAYER AREA --- */
    .player-section { padding: 30px 0; }
    .cinema-wrapper { 
        max-width: 1100px; margin: 0 auto; border-radius: 20px; overflow: hidden; 
        box-shadow: 0 30px 60px rgba(0,0,0,0.8), 0 0 25px rgba(255, 204, 51, 0.08); 
        border: 1px solid var(--border); background: #000; position: relative;
    }
    
    body.cinema-mode-active .navbar, body.cinema-mode-active footer { display: none !important; }
    .player-section.cinema-mode { padding: 0; position: fixed; inset: 0; z-index: 3000; background: #000; display: flex; align-items: center; }
    .player-section.cinema-mode .cinema-wrapper { max-width: 100% !important; border-radius: 0; border: none; }
    
    .close-cinema-btn { 
        position: fixed; top: 25px; right: 25px; z-index: 4000; display: none;
        background: rgba(255,255,255,0.1); color: white; width: 45px; height: 45px; 
        border-radius: 50%; border: 1px solid var(--border); cursor: pointer; backdrop-filter: blur(10px);
    }
    body.cinema-mode-active .close-cinema-btn { display: flex; align-items: center; justify-content: center; }

    /* --- WATCHLIST BUTTON --- */
    .btn-watchlist-ajax { 
        background: #fff; color: #000; padding: 10px 25px; border-radius: 12px;
        font-weight: 700; border: none; transition: 0.3s; font-size: 0.85rem;
        display: inline-flex; align-items: center; gap: 10px;
    }
    .btn-watchlist-ajax.active { background: var(--surface); color: #fff; border: 1px solid var(--border); }

    /* --- EPISODES (LOAD LẠI TRANG) --- */
    .ep-label { font-size: 0.75rem; font-weight: 800; color: #555; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; display: block; }
    .ep-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 50px; }
    .ep-btn { 
        background: var(--surface); border: 1px solid var(--border); color: #777; 
        min-width: 50px; height: 50px; border-radius: 10px; display: flex; 
        align-items: center; justify-content: center; font-weight: 700; transition: 0.25s;
        text-decoration: none; font-size: 0.95rem;
    }
    .ep-btn.active { background: #fff; color: #000; border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.1); }
    .ep-btn:hover:not(.active) { background: rgba(255,255,255,0.1); color: #fff; }

    /* --- BÌNH LUẬN --- */
    .comment-item { 
        padding: 20px; background: var(--surface); border-radius: 18px; 
        border: 1px solid var(--border); display: flex; gap: 18px; margin-bottom: 20px; 
    }
    .user-img { width: 48px; height: 48px; border-radius: 12px; object-fit: cover; border: 1px solid var(--border); }
    .user-name { font-weight: 700; color: #fff; font-size: 0.95rem; }
    .comment-text { color: #ccc; font-size: 0.95rem; margin: 8px 0; line-height: 1.6; }
    
    .btn-delete-cmt, .btn-like-ajax { 
        background: transparent !important; border: none !important; 
        padding: 0 !important; cursor: pointer !important; font-size: 0.8rem !important; 
        color: #555 !important; transition: 0.2s; position: relative; z-index: 10;
    }
    .btn-delete-cmt:hover { color: #ff4d4d !important; }
    .btn-like-ajax:hover { color: #fff !important; }

    /* Sidebar */
    .rec-item { display: flex; gap: 15px; margin-bottom: 20px; text-decoration: none; transition: 0.3s; }
    .rec-img { width: 80px; height: 110px; border-radius: 10px; object-fit: cover; }
    .rec-title { font-family: 'Montserrat', sans-serif !important; color: #fff; font-weight: 600; font-size: 0.9rem; }

    /* Toast */
    #toast-box { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; }
    .custom-toast { background: #fff; color: #000; padding: 12px 30px; border-radius: 50px; font-weight: 700; font-size: 0.85rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
</style>

<div id="toast-box"></div>
<button class="close-cinema-btn" onclick="toggleCinema()"><i class="fas fa-times"></i></button>

<section class="player-section" id="player-area">
    <div class="container px-0 px-md-5">
        <div class="cinema-wrapper" id="cinema-container">
            <div id="player-loader" style="position: absolute; inset: 0; background: #000; z-index: 100; display: none; align-items: center; justify-content: center;">
                <div class="spinner-border text-warning" role="status"></div>
            </div>
            <div class="ratio ratio-16x9">
                {% if can_watch %}
                    <iframe id="main-video-player" src="{{ default_video_url }}" allowfullscreen style="border:none;"></iframe>
                {% else %}
                    <div class="d-flex flex-column align-items-center justify-content-center bg-black h-100 p-5 text-center">
                        <p class="text-white-50 mb-3">{{ age_message }}</p>
                        <a href="{% url 'home' %}" class="btn btn-outline-light rounded-pill px-4 btn-sm">Quay về trang chủ</a>
                    </div>
                {% endif %}
            </div>
            {% if can_watch %}
            <div class="p-2 px-3 d-flex justify-content-between align-items-center bg-black border-top border-white border-opacity-5">
                <span class="small text-white-50" style="font-size: 0.72rem; letter-spacing: 0.5px;">
                    <i class="fas fa-sparkles me-2 text-warning"></i>Chúc bạn xem phim vui vẻ tại BQH MOVIE
                </span>
                <button class="btn btn-sm text-white-50 shadow-none border-0" style="font-size: 0.75rem;" onclick="toggleCinema()"><i class="fas fa-expand-alt me-1"></i> RẠP PHIM</button>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<div class="container px-md-5 mt-3">
    <div class="row g-5">
        <div class="col-lg-8">
            <div class="movie-header">
                <h1 class="movie-title">{{ movie.title }}</h1>
                <div class="d-flex align-items-center gap-3 mb-4">
                    <span class="age-badge">{{ movie.age_limit }}+</span>
                    <span class="text-white-50 small">{{ movie.release_date }}</span>
                    <span class="text-white-50 small">|</span>
                    <span class="text-warning small fw-bold">{{ movie.country }}</span>
                </div>

                <div class="mb-4">
                    {% if user.is_authenticated %}
                    <button id="watchlist-btn" class="btn-watchlist-ajax {% if is_bookmarked %}active{% endif %}" data-url="{% url 'toggle_watchlist' movie.id %}">
                        <i class="fas {% if is_bookmarked %}fa-check{% else %}fa-plus{% endif %}"></i>
                        <span id="watchlist-text">{% if is_bookmarked %}Đã lưu{% else %}Lưu phim{% endif %}</span>
                    </button>
                    {% endif %}
                </div>

                <div class="description-box">
                    <p style="white-space: pre-line;">{{ movie.description|striptags }}</p>
                </div>

                {% if episodes %}
                <span class="ep-label">Danh sách tập</span>
                <div class="ep-grid">
                    {% for ep in episodes %}
                    <a href="?ep={{ forloop.counter }}" class="ep-btn {% if ep.link_ophim == default_video_url %}active{% endif %}">
                        {{ forloop.counter }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="mt-5">
                <h2 style="font-family: 'Montserrat'; font-size: 1.4rem; margin-bottom: 30px;">Bình luận</h2>
                
                {% if user.is_authenticated %}
                <div style="background: var(--surface); padding: 20px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 40px;">
                    <form id="comment-form-ajax" action="{% url 'add_review' movie.id %}" method="POST">
                        {% csrf_token %}
                        <textarea name="comment" class="form-control" style="background: transparent; border: none; color: #fff; padding: 0; box-shadow: none;" placeholder="Chia sẻ cảm nghĩ của bạn..." rows="2" required></textarea>
                        <div class="text-end mt-3">
                            <button type="submit" class="btn btn-warning fw-bold px-4 btn-sm rounded-pill">Gửi</button>
                        </div>
                    </form>
                </div>
                {% endif %}

                <div id="comment-list">
                    {% for r in reviews %}
                    <div class="comment-item" id="review-{{ r.id }}">
                        {% if r.user.profile.avatar %}
                            <img src="{{ r.user.profile.avatar.url }}" class="user-img">
                        {% else %}
                            <img src="https://ui-avatars.com/api/?name={{ r.user.username }}&background=111&color=ffcc33&bold=true&length=1" class="user-img">
                        {% endif %}
                        
                        <div class="w-100">
                            <div class="d-flex justify-content-between">
                                <span class="user-name">{{ r.user.username }}</span>
                                <span class="text-white-50" style="font-size: 0.75rem;">{{ r.created_at|timesince }} trước</span>
                            </div>
                            <div class="comment-text">{{ r.comment }}</div>
                            <div class="d-flex gap-3">
                                <button class="btn-like-ajax" data-url="{% url 'like_review' r.id %}">
                                    <i class="{% if user in r.likes.all %}fas text-danger{% else %}far{% endif %} fa-heart"></i> <span class="count">{{ r.likes.count }}</span>
                                </button>
                                {% if user == r.user or user.is_staff %}
                                <button class="btn-delete-cmt" data-url="{% url 'delete_review' r.id %}" data-id="{{ r.id }}">XÓA</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <span style="font-size: 0.75rem; font-weight: 800; color: var(--primary-gold); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 25px; display: block;">Gợi ý cho bạn</span>
            {% for rec in recommendations %}
            <a href="{% url 'movie_detail' rec.slug %}" class="rec-item">
                <img src="{{ rec.poster_url }}" class="rec-img">
                <div>
                    <div class="rec-title">{{ rec.title }}</div>
                    <div class="text-white-50 small mt-1">{{ rec.release_date }}</div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    function showToast(msg) {
        const box = document.getElementById('toast-box');
        const t = document.createElement('div');
        t.className = `custom-toast show`;
        t.innerHTML = `<span>${msg}</span>`;
        box.appendChild(t);
        setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 400); }, 3000);
    }

    $('#watchlist-btn').on('click', function() {
        var btn = $(this);
        $.ajax({
            url: btn.data('url'),
            type: 'GET',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(data) {
                var icon = btn.find('i');
                var text = $('#watchlist-text');
                if(data.status === 'added') {
                    btn.addClass('active'); icon.attr('class', 'fas fa-check'); text.text('Đã lưu');
                    showToast('Đã thêm vào danh sách');
                } else {
                    btn.removeClass('active'); icon.attr('class', 'fas fa-plus'); text.text('Lưu phim');
                    showToast('Đã gỡ khỏi danh sách');
                }
            }
        });
    });

    $(document).on('click', '.btn-delete-cmt', function(e) {
        e.preventDefault();
        var btn = $(this);
        var reviewId = btn.data('id');
        $('#review-' + reviewId).css('opacity', '0.3');
        $.ajax({
            url: btn.data('url'),
            type: 'POST',
            data: { 'csrfmiddlewaretoken': '{{ csrf_token }}' },
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(data) {
                if(data.status === 'success') {
                    $('#review-' + reviewId).fadeOut(300, function() { $(this).remove(); });
                    showToast('Bình luận đã được xóa');
                }
            }
        });
    });

    $(document).on('click', '.btn-like-ajax', function() {
        var btn = $(this);
        $.ajax({
            url: btn.data('url'),
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(data) {
                btn.find('i').attr('class', data.liked ? 'fas text-danger fa-heart' : 'far fa-heart');
                btn.find('.count').text(data.count);
                showToast(data.liked ? 'Đã thích' : 'Bỏ thích');
            }
        });
    });

    $('#comment-form-ajax').on('submit', function(e) {
        e.preventDefault();
        var form = $(this);
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: form.serialize(),
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(data) {
                if(data.status === 'success') {
                    showToast('Đăng bình luận thành công!');
                    setTimeout(function() { location.reload(); }, 1000);
                }
            }
        });
    });

    function toggleCinema() { 
        $('body').toggleClass('cinema-mode-active'); 
        $('#player-area').toggleClass('cinema-mode'); 
    }
</script>
{% endblock %}