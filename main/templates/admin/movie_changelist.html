{% extends "admin/change_list.html" %}
{% load static %}

{% block object-tools-items %}
    <li>
        <button type="button" id="btn-crawl-logic" class="addlink" style="background: #28a745 !important; color: white; font-weight: bold; border-radius: 4px; padding: 10px 15px; border: none; cursor: pointer;">
            ğŸš€ CÃ€O PHIM Má»šI
        </button>
    </li>
    <li>
        <button type="button" id="btn-tmdb-logic" class="addlink" style="background: #007bff !important; color: white; font-weight: bold; border-radius: 4px; padding: 10px 15px; border: none; cursor: pointer;">
            ğŸ¬ Äá»’NG Bá»˜ TMDB
        </button>
    </li>
    {{ block.super }}
{% endblock %}

{% block content %}
    <div id="crawler-box" style="display: none; background: #111; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <span id="p-status" style="color: #ffcc00; font-weight: bold; font-family: 'Courier New';">â³ ÄANG Xá»¬ LÃ...</span>
            <span id="p-percent" style="color: white; font-weight: bold;">0%</span>
        </div>
        
        <div style="width: 100%; background: #222; height: 10px; border-radius: 5px; overflow: hidden; margin-bottom: 20px; border: 1px solid #444;">
            <div id="p-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #28a745, #007bff); transition: width 0.3s;"></div>
        </div>

        <div id="p-log" style="background: #000; height: 180px; overflow-y: auto; padding: 12px; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; color: #00ff00; border: 1px solid #444; border-radius: 5px; line-height: 1.6;">
            <div style="color: #888;">[INFO] Khá»Ÿi táº¡o mÃ´i trÆ°á»ng...</div>
        </div>
    </div>

    {{ block.super }}

    <script>
        function updateLog(message, isHeader = false) {
            const logBox = document.getElementById('p-log');
            const entry = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span style="color: #555;">[${time}]</span> ${message}`;
            if (isHeader) entry.style.color = '#ffcc00';
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        document.getElementById('btn-crawl-logic').onclick = function() {
            const box = document.getElementById('crawler-box');
            const bar = document.getElementById('p-bar');
            const percentText = document.getElementById('p-percent');
            const statusText = document.getElementById('p-status');
            const btn = this;

            if (!confirm("Báº¯t Ä‘áº§u tiáº¿n trÃ¬nh cÃ o phim?")) return;

            // Reset vÃ  hiá»ƒn thá»‹ giao diá»‡n
            box.style.display = 'block';
            btn.disabled = true;
            btn.style.opacity = '0.5';
            updateLog('Gá»­i yÃªu cáº§u Ä‘áº¿n mÃ¡y chá»§...', true);

            let progress = 0;
            const timer = setInterval(() => {
                if (progress < 90) {
                    progress += 0.5;
                    bar.style.width = progress + '%';
                    percentText.innerText = Math.floor(progress) + '%';
                }
            }, 800);

            fetch('crawl-now/')
                .then(response => {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    function read() {
                        return reader.read().then(({ done, value }) => {
                            if (done) return;
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');
                            
                            lines.forEach(line => {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.substring(6));
                                        updateLog(data.msg);
                                        if (data.done) {
                                            clearInterval(timer);
                                            bar.style.width = '100%';
                                            percentText.innerText = '100%';
                                            statusText.innerText = 'âœ… HOÃ€N THÃ€NH!';
                                            setTimeout(() => window.location.reload(), 2000);
                                        }
                                    } catch(e) {}
                                }
                            });
                            return read();
                        });
                    }
                    return read();
                })
                .catch(err => {
                    clearInterval(timer);
                    updateLog('âŒ Lá»—i káº¿t ná»‘i: ' + err);
                    btn.disabled = false;
                    btn.style.opacity = '1';
                });
        };
    </script>
{% endblock %}