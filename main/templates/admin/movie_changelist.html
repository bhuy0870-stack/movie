{% extends "admin/change_list.html" %}
{% load static %}

{% block object-tools-items %}
    <li>
        <a href="javascript:void(0)" id="btn-crawl-action" class="addlink" style="background: #28a745 !important; color: white; font-weight: bold; border-radius: 4px; padding: 10px 15px;">
            ğŸš€ CÃ€O PHIM Má»šI
        </a>
    </li>
    <li>
        <a href="javascript:void(0)" id="btn-tmdb-action" class="addlink" style="background: #007bff !important; color: white; font-weight: bold; border-radius: 4px; padding: 10px 15px;">
            ğŸ¬ Äá»’NG Bá»˜ TMDB
        </a>
    </li>
    {{ block.super }}
{% endblock %}

{% block content %}
    <div id="progress-wrapper" style="display: none; background: #1a1a1a; padding: 20px; border-radius: 12px; border: 1px solid #333; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span id="progress-label" style="color: #ffcc00; font-weight: 800; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">
                â³ Äang khá»Ÿi táº¡o...
            </span>
            <span id="progress-percentage" style="color: white; font-family: monospace; font-weight: bold; font-size: 1.1rem;">0%</span>
        </div>
        <div style="width: 100%; background: #333; height: 12px; border-radius: 10px; overflow: hidden; border: 1px solid #444;">
            <div id="progress-bar-fill" style="width: 0%; height: 100%; background: linear-gradient(90deg, #28a745, #007bff); transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 15px rgba(0,123,255,0.5);"></div>
        </div>
        <div id="progress-sub-text" style="color: #888; font-size: 0.75rem; margin-top: 8px; font-style: italic;">Vui lÃ²ng khÃ´ng Ä‘Ã³ng trÃ¬nh duyá»‡t cho Ä‘áº¿n khi hoÃ n táº¥t.</div>
    </div>

    {{ block.super }}

    <script>
        function startTask(apiUrl, btnId) {
            const btn = document.getElementById(btnId);
            const wrapper = document.getElementById('progress-wrapper');
            const fill = document.getElementById('progress-bar-fill');
            const label = document.getElementById('progress-label');
            const percentText = document.getElementById('progress-percentage');
            const subText = document.getElementById('progress-sub-text');

            if (!confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n thá»±c hiá»‡n tÃ¡c vá»¥ nÃ y khÃ´ng?')) return;

            // VÃ´ hiá»‡u hÃ³a nÃºt vÃ  hiá»‡n thanh tiáº¿n trÃ¬nh
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.5';
            wrapper.style.display = 'block';
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });

            let progress = 0;
            // Cháº¡y tiáº¿n trÃ¬nh giáº£ láº­p Ä‘á»ƒ táº¡o cáº£m giÃ¡c mÆ°á»£t mÃ 
            const fakeProgress = setInterval(() => {
                if (progress < 92) {
                    progress += Math.random() * 3;
                    fill.style.width = progress + '%';
                    percentText.innerText = Math.floor(progress) + '%';
                    
                    if (progress > 20) label.innerText = 'ğŸ“¡ Äang káº¿t ná»‘i API...';
                    if (progress > 50) label.innerText = 'ğŸ’¾ Äang náº¡p dá»¯ liá»‡u vÃ o Database...';
                    if (progress > 80) label.innerText = 'âš™ï¸ Äang tá»‘i Æ°u hÃ³a hÃ¬nh áº£nh...';
                }
            }, 700);

            // Gá»­i request thá»±c táº¿ tá»›i Django Admin View
            fetch(apiUrl, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(fakeProgress);
                fill.style.width = '100%';
                percentText.innerText = '100%';
                label.innerText = 'âœ… ' + data.message;
                label.style.color = '#28a745';
                subText.innerText = 'Äang lÃ m má»›i danh sÃ¡ch phim...';

                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                clearInterval(fakeProgress);
                alert('âŒ Lá»—i há»‡ thá»‘ng: ' + error);
                window.location.reload();
            });
        }

        // GÃ¡n sá»± kiá»‡n cho cÃ¡c nÃºt
        document.getElementById('btn-crawl-action').onclick = () => startTask('crawl-now/', 'btn-crawl-action');
        document.getElementById('btn-tmdb-action').onclick = () => startTask('sync-tmdb-now/', 'btn-tmdb-action');
    </script>
{% endblock %}