{% extends "admin/change_list.html" %}
{% load static %}

{% block object-tools-items %}
    <li>
        <button type="button" id="btn-crawl-logic" class="addlink" style="background: #28a745 !important; color: white; font-weight: bold; border-radius: 4px; padding: 10px 15px; border: none; cursor: pointer;">
            üöÄ C√ÄO PHIM M·ªöI
        </button>
    </li>
    <li>
        <button type="button" id="btn-tmdb-logic" class="addlink" style="background: #007bff !important; color: white; font-weight: bold; border-radius: 4px; padding: 10px 15px; border: none; cursor: pointer;">
            üé¨ ƒê·ªíNG B·ªò TMDB
        </button>
    </li>
    {{ block.super }}
{% endblock %}

{% block content %}
    <div id="crawler-box" style="display: none; background: #111; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <span id="p-status" style="color: #ffcc00; font-weight: bold; font-family: 'Courier New', monospace; letter-spacing: 1px;">‚è≥ ƒêANG X·ª¨ L√ù...</span>
            <span id="p-percent" style="color: white; font-weight: bold; font-family: monospace;">0%</span>
        </div>
        
        <div style="width: 100%; background: #222; height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 20px; border: 1px solid #444;">
            <div id="p-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #28a745, #007bff); transition: width 0.4s ease;"></div>
        </div>

        <div id="p-log" style="background: #000; height: 180px; overflow-y: auto; padding: 12px; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; color: #00ff00; border: 1px solid #444; border-radius: 5px; line-height: 1.6;">
            <div style="color: #888;">[INFO] H·ªá th·ªëng s·∫µn s√†ng th·ª±c thi t√°c v·ª•...</div>
        </div>
    </div>

    {{ block.super }}

    <script>
        // H√†m ghi nh·∫≠t k√Ω v√†o b·∫£ng log
        function updateLog(message, isHeader = false) {
            const logBox = document.getElementById('p-log');
            const entry = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span style="color: #555;">[${time}]</span> ${message}`;
            if (isHeader) entry.style.color = '#ffcc00';
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        // H√†m x·ª≠ l√Ω ch·∫°y t√°c v·ª• chung (Crawl ho·∫∑c TMDB)
        function runTask(apiUrl, btnId, taskName) {
            const box = document.getElementById('crawler-box');
            const bar = document.getElementById('p-bar');
            const percentText = document.getElementById('p-percent');
            const statusText = document.getElementById('p-status');
            const btn = document.getElementById(btnId);

            if (!confirm(`X√°c nh·∫≠n th·ª±c hi·ªán: ${taskName}?`)) return;

            // Hi·ªÉn th·ªã khung log v√† kh√≥a n√∫t b·∫•m
            box.style.display = 'block';
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.pointerEvents = 'none';
            
            bar.style.width = '0%';
            percentText.innerText = '0%';
            statusText.innerText = `‚è≥ ƒêANG CH·∫†Y: ${taskName}`;
            updateLog(`G·ª≠i y√™u c·∫ßu ${taskName} ƒë·∫øn m√°y ch·ªß...`, true);

            let progress = 0;
            const timer = setInterval(() => {
                if (progress < 92) {
                    progress += 0.4;
                    bar.style.width = progress + '%';
                    percentText.innerText = Math.floor(progress) + '%';
                }
            }, 600);

            fetch(apiUrl)
                .then(response => {
                    // N·∫øu server tr·∫£ v·ªÅ stream (nh∆∞ crawl-now)
                    if (response.headers.get('content-type')?.includes('text/event-stream')) {
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        
                        function read() {
                            return reader.read().then(({ done, value }) => {
                                if (done) return;
                                const chunk = decoder.decode(value);
                                const lines = chunk.split('\n');
                                
                                lines.forEach(line => {
                                    if (line.startsWith('data: ')) {
                                        try {
                                            const data = JSON.parse(line.substring(6));
                                            updateLog(data.msg);
                                            if (data.done) {
                                                finishTask(timer, bar, percentText, statusText);
                                            }
                                        } catch(e) {}
                                    }
                                });
                                return read();
                            });
                        }
                        return read();
                    } else {
                        // N·∫øu server tr·∫£ v·ªÅ JSON (nh∆∞ sync-tmdb-now)
                        return response.json().then(data => {
                            updateLog(data.message);
                            finishTask(timer, bar, percentText, statusText);
                        });
                    }
                })
                .catch(err => {
                    clearInterval(timer);
                    updateLog('‚ùå L·ªói k·∫øt n·ªëi: ' + err);
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.pointerEvents = 'auto';
                });
        }

        function finishTask(timer, bar, percentText, statusText) {
            clearInterval(timer);
            bar.style.width = '100%';
            percentText.innerText = '100%';
            statusText.innerText = '‚úÖ T√ÅC V·ª§ HO√ÄN T·∫§T!';
            updateLog('H·ªá th·ªëng s·∫Ω t·∫£i l·∫°i trang sau 2 gi√¢y...', true);
            setTimeout(() => window.location.reload(), 2000);
        }

        // G√°n s·ª± ki·ªán click cho 2 n√∫t
        document.getElementById('btn-crawl-logic').onclick = function() {
            runTask('crawl-now/', 'btn-crawl-logic', 'C√ÄO PHIM OPHIM');
        };

        document.getElementById('btn-tmdb-logic').onclick = function() {
            runTask('sync-tmdb-now/', 'btn-tmdb-logic', 'ƒê·ªíNG B·ªò TMDB');
        };
    </script>
{% endblock %}