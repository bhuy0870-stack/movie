{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* --- DASHBOARD STYLES --- */
    :root { --primary-gold: #ffcc00; --card-bg: #1e1e1e; --text-main: #e0e0e0; }
    
    .dashboard-container { margin-bottom: 40px; margin-top: 20px; }
    
    /* Stats Grid */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .kpi-card { 
        background: var(--card-bg); border-radius: 15px; padding: 25px; 
        border: 1px solid rgba(255,255,255,0.08); position: relative; overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.3s;
    }
    .kpi-card:hover { transform: translateY(-5px); border-color: var(--primary-gold); }
    .kpi-card::before {
        content: ''; position: absolute; top: -50%; right: -50%; width: 200px; height: 200px;
        background: radial-gradient(circle, rgba(255,255,255,0.05), transparent 70%);
        border-radius: 50%;
    }
    
    .kpi-icon { font-size: 2.5rem; margin-bottom: 15px; opacity: 0.8; }
    .kpi-value { font-size: 2.5rem; font-weight: 900; color: #fff; line-height: 1; margin-bottom: 5px; }
    .kpi-label { font-size: 0.8rem; text-transform: uppercase; color: #888; letter-spacing: 1px; font-weight: 700; }
    .kpi-trend { font-size: 0.8rem; margin-top: 10px; display: inline-block; padding: 3px 8px; border-radius: 4px; background: rgba(255,255,255,0.05); }
    .trend-up { color: #2ecc71; } .trend-down { color: #e74c3c; }

    /* Charts Area */
    .charts-wrapper { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
    @media (max-width: 992px) { .charts-wrapper { grid-template-columns: 1fr; } }
    
    .chart-panel { background: var(--card-bg); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.08); }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px; }
    .chart-title { font-size: 1.1rem; font-weight: 800; color: #fff; border-left: 4px solid var(--primary-gold); padding-left: 10px; }

    /* Recent Actions Table (Override Django Default) */
    #content-main { width: 100% !important; }
    .app-list-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .app-list-section { grid-template-columns: 1fr; } }
    
    .module caption { background: #333 !important; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-icon" style="color: #ff4757;"><i class="fas fa-film"></i></div>
            <div class="kpi-value">{{ dashboard_stats.total_movies }}</div>
            <div class="kpi-label">Kho Phim</div>
            <div class="kpi-trend trend-up"><i class="fas fa-arrow-up"></i> {{ dashboard_stats.new_movies_month }} m·ªõi th√°ng n√†y</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon" style="color: #2ed573;"><i class="fas fa-server"></i></div>
            <div class="kpi-value">{{ dashboard_stats.total_episodes }}</div>
            <div class="kpi-label">T·ªïng T·∫≠p Phim</div>
            <div class="kpi-trend" style="color: #ffa502;"><i class="fas fa-database"></i> Database</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon" style="color: #1e90ff;"><i class="fas fa-users"></i></div>
            <div class="kpi-value">{{ dashboard_stats.total_users }}</div>
            <div class="kpi-label">Th√†nh vi√™n</div>
            <div class="kpi-trend trend-up"><i class="fas fa-user-plus"></i> {{ dashboard_stats.new_users_month }} m·ªõi</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon" style="color: #eccc68;"><i class="fas fa-comments"></i></div>
            <div class="kpi-value">{{ dashboard_stats.total_reviews }}</div>
            <div class="kpi-label">T∆∞∆°ng t√°c (Reviews)</div>
            <div class="kpi-trend" style="color: #fff;"><i class="fas fa-star"></i> Avg: {{ dashboard_stats.avg_rating }}</div>
        </div>
    </div>

    <div class="charts-wrapper">
        <div class="chart-panel">
            <div class="chart-header">
                <span class="chart-title">üìà T·ªëc ƒë·ªô tƒÉng tr∆∞·ªüng (6 th√°ng qua)</span>
            </div>
            <div style="height: 300px; width: 100%;">
                <canvas id="growthChart"></canvas>
            </div>
        </div>

        <div class="chart-panel">
            <div class="chart-header">
                <span class="chart-title">üçï T·ªâ l·ªá N·ªôi dung</span>
            </div>
            <div style="height: 300px; display: flex; justify-content: center;">
                <canvas id="structureChart"></canvas>
            </div>
        </div>
    </div>

</div>

<div class="app-list-section">
    {% for app in app_list %}
        <div class="app-{{ app.app_label }} module">
            <table>
            <caption>
                <a href="{{ app.app_url }}" class="section" title="{% blocktranslate with name=app.name %}Models in the {{ name }} application{% endblocktranslate %}">{{ app.name }}</a>
            </caption>
            {% for model in app.models %}
                <tr class="model-{{ model.object_name|lower }}{% if model.admin_url in request.path %} current-model{% endif %}">
                {% if model.admin_url %}
                    <th scope="row"><a href="{{ model.admin_url }}">{{ model.name }}</a></th>
                {% else %}
                    <th scope="row">{{ model.name }}</th>
                {% endif %}

                {% if model.add_url %}
                    <td><a href="{{ model.add_url }}" class="addlink">{% translate 'Add' %}</a></td>
                {% else %}
                    <td>&nbsp;</td>
                {% endif %}

                {% if model.admin_url %}
                    {% if model.view_only %}
                    <td><a href="{{ model.admin_url }}" class="viewlink">{% translate 'View' %}</a></td>
                    {% else %}
                    <td><a href="{{ model.admin_url }}" class="changelink">{% translate 'Change' %}</a></td>
                    {% endif %}
                {% else %}
                    <td>&nbsp;</td>
                {% endif %}
                </tr>
            {% endfor %}
            </table>
        </div>
    {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctxGrowth = document.getElementById('growthChart').getContext('2d');
    new Chart(ctxGrowth, {
        type: 'line',
        data: {
            labels: {{ dashboard_stats.chart_labels|safe }},
            datasets: [
                {
                    label: 'Th√†nh vi√™n m·ªõi',
                    data: {{ dashboard_stats.chart_user_data|safe }},
                    borderColor: '#1e90ff', backgroundColor: 'rgba(30, 144, 255, 0.1)',
                    tension: 0.4, fill: true, borderWidth: 2
                },
                {
                    label: 'ƒê√°nh gi√° m·ªõi',
                    data: {{ dashboard_stats.chart_review_data|safe }},
                    borderColor: '#eccc68', backgroundColor: 'rgba(236, 204, 104, 0.1)',
                    tension: 0.4, fill: true, borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#ccc' } } },
            scales: {
                y: { grid: { color: '#333' }, ticks: { color: '#888' } },
                x: { grid: { display: false }, ticks: { color: '#888' } }
            }
        }
    });

    const ctxStructure = document.getElementById('structureChart').getContext('2d');
    new Chart(ctxStructure, {
        type: 'doughnut',
        data: {
            labels: ['Phim L·∫ª', 'Phim B·ªô', 'T·∫≠p phim (Server)'],
            datasets: [{
                data: [{{ dashboard_stats.movie_single_count }}, {{ dashboard_stats.movie_series_count }}, {{ dashboard_stats.total_episodes }}],
                backgroundColor: ['#ff4757', '#2ed573', '#5352ed'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { color: '#ccc' } } }
        }
    });
</script>
{% endblock %}