{% extends "admin/change_list.html" %}
{% load static %}

{% block content %}
<style>
    /* --- DASHBOARD DARK THEME PRO --- */
    :root {
        --bg-dark: #1e1e2f;
        --card-bg: #27293d;
        --text-main: #ffffff;
        --text-muted: #9a9a9a;
        --accent: #e14eca; /* T√≠m Neon */
        --success: #00f2c3; /* Xanh ng·ªçc */
        --danger: #fd5d93; /* H·ªìng ƒë·∫≠m */
        --warning: #ff8d72; /* Cam */
    }

    .dashboard-container {
        font-family: 'Segoe UI', Roboto, sans-serif;
        margin-bottom: 30px;
        color: var(--text-main);
    }

    /* KPI CARDS */
    .kpi-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }
    .kpi-card {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        position: relative;
        overflow: hidden;
        transition: transform 0.2s;
    }
    .kpi-card:hover { transform: translateY(-5px); }
    .kpi-icon {
        position: absolute; top: 15px; right: 15px;
        font-size: 2rem; opacity: 0.1; color: #fff;
    }
    .kpi-value { font-size: 2rem; font-weight: bold; margin: 10px 0 5px; }
    .kpi-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    .kpi-growth { font-size: 0.8rem; font-weight: bold; }
    
    .text-up { color: var(--success); }
    .text-down { color: var(--danger); }
    .text-muted { color: var(--text-muted); }

    /* CHART SECTION */
    .chart-row {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
        margin-bottom: 25px;
    }
    .chart-box {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .chart-header {
        font-size: 1.1rem; font-weight: 600; margin-bottom: 15px;
        border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;
    }

    /* TABLE SECTION */
    .table-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    .pro-table { width: 100%; border-collapse: collapse; }
    .pro-table th { 
        text-align: left; color: var(--accent); font-size: 0.8rem; 
        padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); 
    }
    .pro-table td { 
        padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); 
        font-size: 0.9rem; color: #ddd;
    }
    .pro-table tr:last-child td { border-bottom: none; }
    
    .badge-pro { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
    .badge-danger { background: rgba(253, 93, 147, 0.2); color: var(--danger); border: 1px solid var(--danger); }
    .badge-success { background: rgba(0, 242, 195, 0.2); color: var(--success); border: 1px solid var(--success); }

    @media(max-width: 900px) { .chart-row, .table-row { grid-template-columns: 1fr; } }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="dashboard-container">
    <div class="kpi-row">
        <div class="kpi-card" style="border-bottom: 3px solid var(--accent);">
            <div class="kpi-icon">üé¨</div>
            <div class="kpi-label">T·ªïng Phim</div>
            <div class="kpi-value">{{ dashboard.kpi.movies.val }}</div>
            <div class="kpi-growth {% if dashboard.kpi.movies.growth >= 0 %}text-up{% else %}text-down{% endif %}">
                <i class="fas fa-arrow-{% if dashboard.kpi.movies.growth >= 0 %}up{% else %}down{% endif %}"></i>
                {{ dashboard.kpi.movies.growth }}% th√°ng n√†y
            </div>
        </div>
        
        <div class="kpi-card" style="border-bottom: 3px solid var(--success);">
            <div class="kpi-icon">üë•</div>
            <div class="kpi-label">Th√†nh vi√™n</div>
            <div class="kpi-value">{{ dashboard.kpi.users.val }}</div>
            <div class="kpi-growth {% if dashboard.kpi.users.growth >= 0 %}text-up{% else %}text-down{% endif %}">
                <i class="fas fa-arrow-{% if dashboard.kpi.users.growth >= 0 %}up{% else %}down{% endif %}"></i>
                {{ dashboard.kpi.users.growth }}% th√°ng n√†y
            </div>
        </div>

        <div class="kpi-card" style="border-bottom: 3px solid var(--danger);">
            <div class="kpi-icon">‚ö†Ô∏è</div>
            <div class="kpi-label">C·∫ßn x·ª≠ l√Ω g·∫•p</div>
            <div class="kpi-value text-down">{{ dashboard.kpi.missing_eps }}</div>
            <div class="kpi-growth text-muted">Phim ch∆∞a c√≥ t·∫≠p n√†o</div>
        </div>

        <div class="kpi-card" style="border-bottom: 3px solid var(--warning);">
            <div class="kpi-icon">ü§ñ</div>
            <div class="kpi-label">AI T√≠ch c·ª±c</div>
            <div class="kpi-value text-up">{{ dashboard.kpi.ai_pos_pct }}%</div>
            <div class="kpi-growth text-muted">D·ª±a tr√™n {{ dashboard.kpi.reviews.val }} reviews</div>
        </div>
    </div>

    <div class="chart-row">
        <div class="chart-box">
            <div class="chart-header">ü§ñ Ph√¢n t√≠ch c·∫£m x√∫c (AI PhoBERT)</div>
            <canvas id="sentimentChart" height="200"></canvas>
            <div style="text-align: center; margin-top: 10px; font-size: 0.8rem; color: #888;">
                T·ª∑ l·ªá: Khen (Xanh) - Trung l·∫≠p (X√°m) - Ch√™ (ƒê·ªè)
            </div>
        </div>
        <div class="chart-box">
            <div class="chart-header">üî• Xu h∆∞·ªõng th·ªÉ lo·∫°i phim</div>
            <canvas id="genreChart" height="100"></canvas>
        </div>
    </div>

    <div class="table-row">
        <div class="chart-box">
            <div class="chart-header">üö© Phim b·ªã ch√™ nhi·ªÅu nh·∫•t (C·∫ßn check)</div>
            <table class="pro-table">
                <thead><tr><th>T√äN PHIM</th><th>REVIEW CH√ä</th><th>TR·∫†NG TH√ÅI</th></tr></thead>
                <tbody>
                    {% for m in dashboard.tables.problems %}
                    <tr>
                        <td><a href="/admin/main/movie/{{ m.id }}/change/" style="color:#fff; text-decoration:none;">{{ m.title }}</a></td>
                        <td class="text-down fw-bold">{{ m.bad_reviews }}</td>
                        <td><span class="badge-pro badge-danger">High Alert</span></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center text-muted">Tuy·ªát v·ªùi! Kh√¥ng c√≥ phim n√†o qu√° t·ªá.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="chart-box">
            <div class="chart-header">üèÜ Top User t√≠ch c·ª±c</div>
            <table class="pro-table">
                <thead><tr><th>USERNAME</th><th>EMAIL</th><th>B√åNH LU·∫¨N</th></tr></thead>
                <tbody>
                    {% for u in dashboard.tables.top_users %}
                    <tr>
                        <td>
                            <i class="fas fa-crown text-warning me-1"></i>
                            <a href="/admin/auth/user/{{ u.id }}/change/" style="color:#fff; font-weight:bold;">{{ u.username }}</a>
                        </td>
                        <td class="text-muted small">{{ u.email }}</td>
                        <td><span class="badge-pro badge-success">{{ u.review_count }} posts</span></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center text-muted">Ch∆∞a c√≥ user n√†o t√≠ch c·ª±c.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{{ block.super }}

<script>
    // 1. BI·ªÇU ƒê·ªí SENTIMENT (AI)
    const ctxSent = document.getElementById('sentimentChart').getContext('2d');
    new Chart(ctxSent, {
        type: 'doughnut',
        data: {
            labels: ['T√≠ch c·ª±c', 'Trung l·∫≠p', 'Ti√™u c·ª±c'],
            datasets: [{
                data: {{ dashboard.charts.sentiment|safe }},
                backgroundColor: ['#00f2c3', '#525f7f', '#fd5d93'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true, cutout: '70%',
            plugins: { legend: { display: false } }
        }
    });

    // 2. BI·ªÇU ƒê·ªí TH·ªÇ LO·∫†I
    const ctxGenre = document.getElementById('genreChart').getContext('2d');
    new Chart(ctxGenre, {
        type: 'bar',
        data: {
            labels: {{ dashboard.charts.genre_labels|safe }},
            datasets: [{
                label: 'S·ªë l∆∞·ª£ng phim',
                data: {{ dashboard.charts.genre_values|safe }},
                backgroundColor: '#e14eca', borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#9a9a9a' } },
                x: { grid: { display: false }, ticks: { color: '#9a9a9a' } }
            },
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %}